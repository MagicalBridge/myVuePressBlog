<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>褚鹏飞的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="终于等到你">
    
    <link rel="preload" href="/assets/css/0.styles.495d9abf.css" as="style"><link rel="preload" href="/assets/js/app.f02bee95.js" as="script"><link rel="preload" href="/assets/js/2.b8567e4f.js" as="script"><link rel="preload" href="/assets/js/4.80e3ddd3.js" as="script"><link rel="prefetch" href="/assets/js/10.5c255501.js"><link rel="prefetch" href="/assets/js/11.4b94074e.js"><link rel="prefetch" href="/assets/js/12.08c271cf.js"><link rel="prefetch" href="/assets/js/13.c1d962dc.js"><link rel="prefetch" href="/assets/js/14.4d6f5a9d.js"><link rel="prefetch" href="/assets/js/15.cedbc73b.js"><link rel="prefetch" href="/assets/js/16.f5feb366.js"><link rel="prefetch" href="/assets/js/17.efc1eb10.js"><link rel="prefetch" href="/assets/js/18.cb4401f7.js"><link rel="prefetch" href="/assets/js/19.85af727c.js"><link rel="prefetch" href="/assets/js/20.bf4655a7.js"><link rel="prefetch" href="/assets/js/21.700252eb.js"><link rel="prefetch" href="/assets/js/22.bbaa3960.js"><link rel="prefetch" href="/assets/js/23.6d4f6d39.js"><link rel="prefetch" href="/assets/js/24.15d826a4.js"><link rel="prefetch" href="/assets/js/25.8d876c7a.js"><link rel="prefetch" href="/assets/js/26.b863e65b.js"><link rel="prefetch" href="/assets/js/27.7369d143.js"><link rel="prefetch" href="/assets/js/28.4149b07f.js"><link rel="prefetch" href="/assets/js/29.34b91260.js"><link rel="prefetch" href="/assets/js/3.3e34fbec.js"><link rel="prefetch" href="/assets/js/30.a1b34e7a.js"><link rel="prefetch" href="/assets/js/31.e437cf01.js"><link rel="prefetch" href="/assets/js/32.86235dc5.js"><link rel="prefetch" href="/assets/js/33.84402b64.js"><link rel="prefetch" href="/assets/js/34.7d9518f8.js"><link rel="prefetch" href="/assets/js/35.a560bc61.js"><link rel="prefetch" href="/assets/js/36.c956c7cf.js"><link rel="prefetch" href="/assets/js/37.9a8e7918.js"><link rel="prefetch" href="/assets/js/38.e441e0f6.js"><link rel="prefetch" href="/assets/js/39.9dd2baf8.js"><link rel="prefetch" href="/assets/js/40.33f42999.js"><link rel="prefetch" href="/assets/js/41.f8678602.js"><link rel="prefetch" href="/assets/js/42.c645c1e6.js"><link rel="prefetch" href="/assets/js/43.3f56a462.js"><link rel="prefetch" href="/assets/js/44.369664e2.js"><link rel="prefetch" href="/assets/js/45.a3ce43e6.js"><link rel="prefetch" href="/assets/js/46.76c69a77.js"><link rel="prefetch" href="/assets/js/47.478b3ad4.js"><link rel="prefetch" href="/assets/js/48.e3a97cfa.js"><link rel="prefetch" href="/assets/js/49.c400a754.js"><link rel="prefetch" href="/assets/js/5.12c10b08.js"><link rel="prefetch" href="/assets/js/50.c59caeab.js"><link rel="prefetch" href="/assets/js/51.263e49b7.js"><link rel="prefetch" href="/assets/js/52.5f0883f7.js"><link rel="prefetch" href="/assets/js/53.9106a677.js"><link rel="prefetch" href="/assets/js/54.c08742ea.js"><link rel="prefetch" href="/assets/js/55.b0bca3d5.js"><link rel="prefetch" href="/assets/js/56.a6258bd5.js"><link rel="prefetch" href="/assets/js/57.d1affb53.js"><link rel="prefetch" href="/assets/js/58.538cafa3.js"><link rel="prefetch" href="/assets/js/6.2f29e480.js"><link rel="prefetch" href="/assets/js/7.8a10ff5e.js"><link rel="prefetch" href="/assets/js/8.4b53a665.js"><link rel="prefetch" href="/assets/js/9.a572a8b2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.495d9abf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">褚鹏飞的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithms/" class="nav-link">
  常用算法
</a></li><li class="dropdown-item"><!----> <a href="/leetCode/leetCode/" class="nav-link">
  leetCode算题解
</a></li><li class="dropdown-item"><!----> <a href="/leetCode/valuableBook/" class="nav-link">
  面试题
</a></li><li class="dropdown-item"><!----> <a href="/leetCode/offer/" class="nav-link">
  剑指offer
</a></li></ul></div></div><div class="nav-item"><a href="/dataStructure/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/network/" class="nav-link">
  计算机网络
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue" class="dropdown-title"><span class="title">Vue</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue" class="mobile-dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/vue-analysis/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Vue2内部原理剖析
</a></li><li class="dropdown-item"><!----> <a href="/vue/vue3-analysis/" class="nav-link">
  Vue3内部原理剖析
</a></li><li class="dropdown-item"><!----> <a href="/vue/vue-component/" class="nav-link">
  Vue组件探索
</a></li><li class="dropdown-item"><!----> <a href="/vue/vuex/" class="nav-link">
  Vuex源码解析
</a></li><li class="dropdown-item"><!----> <a href="/vue/vue-router/" class="nav-link">
  Vue-Router源码解析
</a></li></ul></div></div><div class="nav-item"><a href="/react/" class="nav-link">
  React
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack" class="dropdown-title"><span class="title">webpack</span> <span class="arrow down"></span></button> <button type="button" aria-label="webpack" class="mobile-dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/webpack-base.html" class="nav-link">
  webpack基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node.js" class="dropdown-title"><span class="title">Node.js</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node.js" class="mobile-dropdown-title"><span class="title">Node.js</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/node-base/" class="nav-link">
  Node基础
</a></li><li class="dropdown-item"><!----> <a href="/node/express/" class="nav-link">
  Express
</a></li><li class="dropdown-item"><!----> <a href="/node/koa/" class="nav-link">
  Koa
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="服务端" class="dropdown-title"><span class="title">服务端</span> <span class="arrow down"></span></button> <button type="button" aria-label="服务端" class="mobile-dropdown-title"><span class="title">服务端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">
  linux
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git工具
</a></li><li class="dropdown-item"><!----> <a href="/nginx/nginx-base/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/k8s/" class="nav-link">
  kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link">
  mySql
</a></li><li class="dropdown-item"><!----> <a href="/database/mongodb/" class="nav-link">
  mongodb
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端三剑客" class="dropdown-title"><span class="title">前端三剑客</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端三剑客" class="mobile-dropdown-title"><span class="title">前端三剑客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/threemusketeers/javascript/" class="nav-link">
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/threemusketeers/html/" class="nav-link">
  HTML
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithms/" class="nav-link">
  常用算法
</a></li><li class="dropdown-item"><!----> <a href="/leetCode/leetCode/" class="nav-link">
  leetCode算题解
</a></li><li class="dropdown-item"><!----> <a href="/leetCode/valuableBook/" class="nav-link">
  面试题
</a></li><li class="dropdown-item"><!----> <a href="/leetCode/offer/" class="nav-link">
  剑指offer
</a></li></ul></div></div><div class="nav-item"><a href="/dataStructure/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/network/" class="nav-link">
  计算机网络
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue" class="dropdown-title"><span class="title">Vue</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue" class="mobile-dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vue/vue-analysis/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Vue2内部原理剖析
</a></li><li class="dropdown-item"><!----> <a href="/vue/vue3-analysis/" class="nav-link">
  Vue3内部原理剖析
</a></li><li class="dropdown-item"><!----> <a href="/vue/vue-component/" class="nav-link">
  Vue组件探索
</a></li><li class="dropdown-item"><!----> <a href="/vue/vuex/" class="nav-link">
  Vuex源码解析
</a></li><li class="dropdown-item"><!----> <a href="/vue/vue-router/" class="nav-link">
  Vue-Router源码解析
</a></li></ul></div></div><div class="nav-item"><a href="/react/" class="nav-link">
  React
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack" class="dropdown-title"><span class="title">webpack</span> <span class="arrow down"></span></button> <button type="button" aria-label="webpack" class="mobile-dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/webpack/webpack-base.html" class="nav-link">
  webpack基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Node.js" class="dropdown-title"><span class="title">Node.js</span> <span class="arrow down"></span></button> <button type="button" aria-label="Node.js" class="mobile-dropdown-title"><span class="title">Node.js</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/node-base/" class="nav-link">
  Node基础
</a></li><li class="dropdown-item"><!----> <a href="/node/express/" class="nav-link">
  Express
</a></li><li class="dropdown-item"><!----> <a href="/node/koa/" class="nav-link">
  Koa
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="服务端" class="dropdown-title"><span class="title">服务端</span> <span class="arrow down"></span></button> <button type="button" aria-label="服务端" class="mobile-dropdown-title"><span class="title">服务端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">
  linux
</a></li><li class="dropdown-item"><!----> <a href="/git/" class="nav-link">
  git工具
</a></li><li class="dropdown-item"><!----> <a href="/nginx/nginx-base/" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/k8s/" class="nav-link">
  kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link">
  mySql
</a></li><li class="dropdown-item"><!----> <a href="/database/mongodb/" class="nav-link">
  mongodb
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端三剑客" class="dropdown-title"><span class="title">前端三剑客</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端三剑客" class="mobile-dropdown-title"><span class="title">前端三剑客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/threemusketeers/javascript/" class="nav-link">
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/threemusketeers/html/" class="nav-link">
  HTML
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/vue-analysis/#一、vue内部机制剖析" class="sidebar-link">一、Vue内部机制剖析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue/vue-analysis/#初始化及挂载" class="sidebar-link">初始化及挂载</a></li><li class="sidebar-sub-header"><a href="/vue/vue-analysis/#编译" class="sidebar-link">编译</a></li><li class="sidebar-sub-header"><a href="/vue/vue-analysis/#响应式" class="sidebar-link">响应式</a></li><li class="sidebar-sub-header"><a href="/vue/vue-analysis/#virtual-dom" class="sidebar-link">Virtual DOM</a></li><li class="sidebar-sub-header"><a href="/vue/vue-analysis/#更新视图" class="sidebar-link">更新视图</a></li><li class="sidebar-sub-header"><a href="/vue/vue-analysis/#再看全局" class="sidebar-link">再看全局</a></li></ul></li><li><a href="/vue/vue-analysis/#二、响应式系统的基本原理" class="sidebar-link">二、响应式系统的基本原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue/vue-analysis/#响应式系统" class="sidebar-link">响应式系统</a></li><li class="sidebar-sub-header"><a href="/vue/vue-analysis/#object-defineproperty" class="sidebar-link">Object.defineProperty</a></li><li class="sidebar-sub-header"><a href="/vue/vue-analysis/#实现-observer-可观察的" class="sidebar-link">实现 observer(可观察的)</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="一、vue内部机制剖析"><a href="#一、vue内部机制剖析" class="header-anchor">#</a> 一、Vue内部机制剖析</h2> <p>首先，我们整体的介绍下vue.js内部的整个运行流程，希望能让大家有一个整体的印象，然后我们再逐个模块进行讲解。从来没有了解过<code>vue.js</code>实现的同学可能会对一些内容感到疑惑，这是正常的，我们不妨有些耐心，耐心的将内容看完，再回来观看这一部分，相信会有收获的。</p> <p>首先，我们来看下vue的内部运行流程图。</p> <p><img src="/assets/img/01.5d04e220.png" alt="vue内部运行机制"></p> <p>大家第一次看到这个图一定是一头雾水，没有关系，我们来逐个讲解一下这些模块的作用以及调用关系，相信大家对于<code>vue.js</code>内部运行机制会有一个大概的认识。</p> <h3 id="初始化及挂载"><a href="#初始化及挂载" class="header-anchor">#</a> 初始化及挂载</h3> <p><img src="/assets/img/02.0d92d8b4.png" alt="初始化挂载"></p> <p>在 <code>new Vue()</code>之后。Vue会调用 <code>_init</code> 函数进行初始化，也就是这里的<code>init</code>过程，它会初始化生命周期、事件、props、methods、data、computed 与 watch等。其中最重要的是通过<code>Object.defineProperty</code>设置 <code>setter</code> 与 <code>getter</code> 函数，用来实现「<strong>响应式</strong>」和「<strong>依赖收集</strong>」。</p> <p>初始化之后调用 <code>$mount</code> 会挂载组件、如果是<strong>运行时编译</strong>，即不存在 <code>render function</code> 但是存在 template, 需要进行「编译」步骤。</p> <h3 id="编译"><a href="#编译" class="header-anchor">#</a> 编译</h3> <p>compile编译可以分为 parse、optimize与generate三个阶段，最终需要得到render function。</p> <p><img src="/assets/img/03.7ec12667.png" alt="编译过程"></p> <h4 id="parse"><a href="#parse" class="header-anchor">#</a> parse</h4> <p>parse 会用正则等方式解析 template 模板中的指令、class、style等数据，形成AST。</p> <h4 id="optimize"><a href="#optimize" class="header-anchor">#</a> optimize</h4> <p>optimize的主要作用是标记static静态节点，这是vue在编译过程中的一处优化，后面当 update 更新界面时，会有一个patch过程，diff算法会直接跳过静态节点，从而减少了比较的过程，优化了patch的性能。</p> <h4 id="generate"><a href="#generate" class="header-anchor">#</a> generate</h4> <p>generate 是将AST转化为 render function  字符串的过程，得到结果是 render的字符串以及staticRenderFns 字符串。</p> <p>在经过 parse、optimize与generate 这三个阶段以后，组价中就会存在渲染Vnode所需要的 render function 了。</p> <h3 id="响应式"><a href="#响应式" class="header-anchor">#</a> 响应式</h3> <p>接下来也就是 vue.js的响应式核心部分</p> <p><img src="/assets/img/04.098d8b8c.png" alt="vue响应式"></p> <p>这里的<code>getter</code>和<code>setter</code>已经在之前介绍过了，在<code>init</code>的时候通过<code>Object.defineProperty</code> 进行了绑定，它使得当被设置的对象读取的时候会执行<code>getter</code>函数，而当被赋值的时候执行<code>setter</code>函数。</p> <p>当<code>render function</code> 被渲染的时候，因为会读取所需对象的值，所以会触发 <code>getter</code>函数进行「<strong>依赖收集</strong>」，「<strong>依赖收集</strong>」的目的是将观察者 Watcher 对象存放到当前订阅者 Dep的subs 中，形成如下所示的这样一个关系。</p> <p><img src="/assets/img/05.7d7ee661.png" alt="依赖收集关系图"></p> <p>在修改对象的值的时候，会触发对应的 <code>setter</code>，<code>setter</code> 通知之前「<strong>依赖收集</strong>」得到的Dep中的每一个Watcher，告诉它们自己的值改变了，需要重新渲染视图。这个时候这些Watcher就开始调用<code>update</code>来更新视图。当然这中间还有一个<code>patch</code>的过程以及使用队列来异步更新策略。这个后面我们会做详细介绍。</p> <h3 id="virtual-dom"><a href="#virtual-dom" class="header-anchor">#</a> Virtual DOM</h3> <p>我们知道，render function 会被转化为 Vnode 节点。Virtual DOM 其实就是一颗以JavaScript对象（VNode节点）作为基础的树，用对象属性来描述节点，实际上它只是一层真实DOM的抽象。最终可以通过一系列操作使这颗树映射到真实环境上。由于Virtual DOM是以JavaScript对象为基础而不依赖真实平台环境，所以它具有跨平台的能力，比如浏览器平台、Weex、Node等。</p> <p>比如说下面这样一个例子:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  tag: 'div',                 /*说明这是一个div标签*/
  children: [                 /*存放该标签的子节点*/
    {
      tag: 'a',               /*说明这是一个a标签*/
      text: 'click me'        /*标签的内容*/
    }
  ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>渲染后可以得到</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;div&gt;
  &lt;a&gt;click me&lt;/a&gt;
&lt;/div&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这只是一个简单的例子，实际上的节点有更多的属性来标志节点，比如isStatic(代表是否为静态节点)、isComponent （代表是否为注释节点）等。</p> <h3 id="更新视图"><a href="#更新视图" class="header-anchor">#</a> 更新视图</h3> <p><img src="/assets/img/06.b275aa02.png" alt="更新视图"></p> <p>前面我们说到，在修改一个对象值的时候，会通过 setter -&gt; Watcher -&gt; update 的流程来修改对应的视图，那么最终是如何更新视图的呢？</p> <p>当数据变化后，执行 render function 就可以得到一个新的VNode节点，然后用innerHTML 直接渲染到真实的DOM。 但是其实我们只对其中的一小块内容进行修改，这样做似乎有些 「<strong>浪费</strong>」。</p> <p>那么我们为什么不能只修改那些「改变了的地方」呢？这个时候就要介绍「patch」了。我们会将新的 VNode 与旧的 VNode 一起传入 patch 进行比较。经过diff算法得出它们的「<strong>差异</strong>」。最后我们只需要将这些「<strong>差异</strong>」的对应DOM 进行修改即可。</p> <h3 id="再看全局"><a href="#再看全局" class="header-anchor">#</a> 再看全局</h3> <p><img src="/assets/img/01.5d04e220.png" alt="vue内部运行机制"></p> <p>回过头再来看看这张图，是不是大脑中已经有一个大概的脉络了呢？</p> <p>那么，让我们继续学习每一个模块吧!</p> <h2 id="二、响应式系统的基本原理"><a href="#二、响应式系统的基本原理" class="header-anchor">#</a> 二、响应式系统的基本原理</h2> <h3 id="响应式系统"><a href="#响应式系统" class="header-anchor">#</a> 响应式系统</h3> <p>vue.js数据模型仅仅是普通的JavaScript对象，但是对这些对象进行操作时，却能影响对应视图，它的核心就是「<strong>响应式系统</strong>」。尽管我们在使用vue.js进行开发时候不会直接修改「<strong>响应式系统</strong>」，但是理解它的实现有助于避开一些常见的 「坑」，也有助于在遇见一些琢磨不透的问题可以深入其原理来解决它。</p> <h3 id="object-defineproperty"><a href="#object-defineproperty" class="header-anchor">#</a> <code>Object.defineProperty</code></h3> <p>首先我们介绍下 <code>Object.defineProperty</code>,vue.js就是基于它实现「响应式系统」的。</p> <p>首先是使用方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * obj: 目标对象
 * prop: 需要操作的目标对象的属性名 
 * descriptor: 描述符
 * return value 传入对象
 */</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>descriptor的一些属性，简单介绍几个属性，具体可以参考 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="noopener noreferrer">MDN 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <ul><li>enumerable, 属性是否可以枚举，默认是false</li> <li>configurable, 属性是否可以被修改或者删除，默认是false。</li> <li>get，获取属性的方法。</li> <li>set，设置属性的方法。</li></ul> <h3 id="实现-observer-可观察的"><a href="#实现-observer-可观察的" class="header-anchor">#</a> 实现 observer(可观察的)</h3> <p>知道了 <code>Object.defineProperty</code> 以后，我们来用它使对象变成可观察的。</p> <p>在init阶段会进行初始化，对数据进行「<strong>响应式化</strong>」。</p> <p><img src="/assets/img/02.0d92d8b4.png" alt="初始化挂载"></p> <p>为了方便理解，我们不考虑数组等复杂的情况，只对对象进行处理。</p> <p>首先我们定义一个cb函数， 这个函数用来模拟视图更新，调用它即代表更新视图，内部可以是一些更新视图的方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cb</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 渲染视图 */</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;视图更新啦～&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后我们定义一个 <code>defineReactive</code> 方法, 这个方法通过 <code>Object.defineProperty</code>来实现对对象「<strong>响应式</strong>」化，入参是一个obj（需要绑定的对象），key（obj的某一个属性），val（具体的值）。经过 <code>defineReactive</code> 处理之后，我们的obj的key属性在「读」的时候会触发 <code>reactiveGetter</code>方法，而在该属性被「写」的时候会触发 <code>reactiveSetter</code> 方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>       <span class="token comment">/* 属性可枚举 */</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>     <span class="token comment">/* 属性可被修改或删除 */</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> val<span class="token punctuation">;</span>           <span class="token comment">/* 实际上会依赖收集，下一小节会讲 */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> val<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>当然这还是不够的，我们需要在上面再封装一层 <code>observer</code>。这个函数传入一个value（需要『<strong>响应式</strong>』化的对象），通过遍历所有属性的方式对该对象的每一个属性都通过 <code>defineReactive</code> 处理。（注：实际上observer 会进行递归调用，为了便于理解去掉了递归的过程 ）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">observer</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>最后，让我们用<code>oberve</code>来封装一个Vue吧</p> <p>在Vue的构造函数中，对options的data处理，这里的data大家都很熟悉，就是平时我们写在Vue项目中的data属性(实际上是一个函数，这里当做一个对象来处理)。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
  <span class="token comment">/* vue的构造类 */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">optioons</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_data <span class="token operator">=</span> options<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这样我们只要new 一个 Vue对象，就会将data中的数据，进行「响应式」化。如果我们对data的属性进行下面的操作，就会触发cb方法更新视图。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  data<span class="token operator">:</span><span class="token punctuation">{</span>
    test<span class="token operator">:</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

o<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span> <span class="token comment">/*视图更新了*/</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>至此，响应式原理已经介绍完毕了，接下来我们来介绍「响应式系统」的另一部分 —— 「依赖收集」。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f02bee95.js" defer></script><script src="/assets/js/2.b8567e4f.js" defer></script><script src="/assets/js/4.80e3ddd3.js" defer></script>
  </body>
</html>
